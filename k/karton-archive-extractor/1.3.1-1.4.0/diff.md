# Comparing `tmp/karton_archive_extractor-1.3.1-py3-none-any.whl.zip` & `tmp/karton_archive_extractor-1.4.0-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,14 +1,14 @@
-Zip file size: 17921 bytes, number of entries: 12
--rw-r--r--  2.0 unx      539 b- defN 22-Sep-28 12:40 karton_archive_extractor-1.3.1-nspkg.pth
--rw-r--r--  2.0 unx       80 b- defN 22-Sep-28 12:40 karton/archive_extractor/__init__.py
--rw-r--r--  2.0 unx       73 b- defN 22-Sep-28 12:40 karton/archive_extractor/__main__.py
--rw-r--r--  2.0 unx       22 b- defN 22-Sep-28 12:40 karton/archive_extractor/__version__.py
--rw-r--r--  2.0 unx     4222 b- defN 22-Sep-28 12:40 karton/archive_extractor/archive_extractor.py
--rw-r--r--  2.0 unx    35149 b- defN 22-Sep-28 12:40 karton_archive_extractor-1.3.1.dist-info/LICENSE
--rw-r--r--  2.0 unx     2497 b- defN 22-Sep-28 12:40 karton_archive_extractor-1.3.1.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 22-Sep-28 12:40 karton_archive_extractor-1.3.1.dist-info/WHEEL
--rw-r--r--  2.0 unx       93 b- defN 22-Sep-28 12:40 karton_archive_extractor-1.3.1.dist-info/entry_points.txt
--rw-r--r--  2.0 unx        7 b- defN 22-Sep-28 12:40 karton_archive_extractor-1.3.1.dist-info/namespace_packages.txt
--rw-r--r--  2.0 unx        7 b- defN 22-Sep-28 12:40 karton_archive_extractor-1.3.1.dist-info/top_level.txt
-?rw-rw-r--  2.0 unx     1174 b- defN 22-Sep-28 12:40 karton_archive_extractor-1.3.1.dist-info/RECORD
-12 files, 43955 bytes uncompressed, 15867 bytes compressed:  63.9%
+Zip file size: 18958 bytes, number of entries: 12
+-rw-r--r--  2.0 unx      539 b- defN 23-May-22 10:37 karton_archive_extractor-1.4.0-nspkg.pth
+-rw-r--r--  2.0 unx       80 b- defN 23-May-22 10:37 karton/archive_extractor/__init__.py
+-rw-r--r--  2.0 unx       73 b- defN 23-May-22 10:37 karton/archive_extractor/__main__.py
+-rw-r--r--  2.0 unx       22 b- defN 23-May-22 10:37 karton/archive_extractor/__version__.py
+-rw-r--r--  2.0 unx     6280 b- defN 23-May-22 10:37 karton/archive_extractor/archive_extractor.py
+-rw-r--r--  2.0 unx    35149 b- defN 23-May-22 10:37 karton_archive_extractor-1.4.0.dist-info/LICENSE
+-rw-r--r--  2.0 unx     3725 b- defN 23-May-22 10:37 karton_archive_extractor-1.4.0.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 23-May-22 10:37 karton_archive_extractor-1.4.0.dist-info/WHEEL
+-rw-r--r--  2.0 unx       93 b- defN 23-May-22 10:37 karton_archive_extractor-1.4.0.dist-info/entry_points.txt
+-rw-r--r--  2.0 unx        7 b- defN 23-May-22 10:37 karton_archive_extractor-1.4.0.dist-info/namespace_packages.txt
+-rw-r--r--  2.0 unx        7 b- defN 23-May-22 10:37 karton_archive_extractor-1.4.0.dist-info/top_level.txt
+?rw-rw-r--  2.0 unx     1174 b- defN 23-May-22 10:37 karton_archive_extractor-1.4.0.dist-info/RECORD
+12 files, 47241 bytes uncompressed, 16904 bytes compressed:  64.2%
```

## zipnote {}

```diff
@@ -1,37 +1,37 @@
-Filename: karton_archive_extractor-1.3.1-nspkg.pth
+Filename: karton_archive_extractor-1.4.0-nspkg.pth
 Comment: 
 
 Filename: karton/archive_extractor/__init__.py
 Comment: 
 
 Filename: karton/archive_extractor/__main__.py
 Comment: 
 
 Filename: karton/archive_extractor/__version__.py
 Comment: 
 
 Filename: karton/archive_extractor/archive_extractor.py
 Comment: 
 
-Filename: karton_archive_extractor-1.3.1.dist-info/LICENSE
+Filename: karton_archive_extractor-1.4.0.dist-info/LICENSE
 Comment: 
 
-Filename: karton_archive_extractor-1.3.1.dist-info/METADATA
+Filename: karton_archive_extractor-1.4.0.dist-info/METADATA
 Comment: 
 
-Filename: karton_archive_extractor-1.3.1.dist-info/WHEEL
+Filename: karton_archive_extractor-1.4.0.dist-info/WHEEL
 Comment: 
 
-Filename: karton_archive_extractor-1.3.1.dist-info/entry_points.txt
+Filename: karton_archive_extractor-1.4.0.dist-info/entry_points.txt
 Comment: 
 
-Filename: karton_archive_extractor-1.3.1.dist-info/namespace_packages.txt
+Filename: karton_archive_extractor-1.4.0.dist-info/namespace_packages.txt
 Comment: 
 
-Filename: karton_archive_extractor-1.3.1.dist-info/top_level.txt
+Filename: karton_archive_extractor-1.4.0.dist-info/top_level.txt
 Comment: 
 
-Filename: karton_archive_extractor-1.3.1.dist-info/RECORD
+Filename: karton_archive_extractor-1.4.0.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## karton/archive_extractor/__version__.py

```diff
@@ -1 +1 @@
-__version__ = "1.3.1"
+__version__ = "1.4.0"
```

## karton/archive_extractor/archive_extractor.py

```diff
@@ -1,35 +1,85 @@
 import tempfile
+from typing import Optional
 
 from karton.core import Karton, Resource, Task
+from karton.core.backend import KartonBackend
+from karton.core.config import Config
 from sflock import unpack  # type: ignore
 
 from .__version__ import __version__
 
+try:
+    import pefile  # type: ignore
+    from debloat.processor import process_pe  # type: ignore
+
+    HAS_DEBLOAT = True
+except ImportError:
+    HAS_DEBLOAT = False
+
 
 class ArchiveExtractor(Karton):
     """
     Extracts files from known archives and e-mail attachments.
     Produces "raw" artifacts for further classification.
     """
 
-    # Maximum levels of nested extraction
-    max_depth = 5
-    # Maximum unpacked child filesize, larger files are not reported
-    max_size = 25 * 1024 * 1024
-    # Maximum number of childs for further analysis
-    max_children = 1000
-
     identity = "karton.archive-extractor"
     version = __version__
     persistent = True
     filters = [
         {"type": "sample", "stage": "recognized", "kind": "archive"},
     ]
 
+    def __init__(
+        self,
+        config: Optional[Config] = None,
+        identity: Optional[str] = None,
+        backend: Optional[KartonBackend] = None,
+    ) -> None:
+        super().__init__(config=config, identity=identity, backend=backend)
+
+        # Maximum levels of nested extraction
+        self.max_depth = self.config.getint(
+            "archive-extractor", "max_depth", fallback=5
+        )
+        # Maximum unpacked child filesize, larger files are not reported
+        self.max_size = self.config.getint(
+            "archive-extractor", "max_size", fallback=25 * 1024 * 1024
+        )
+        # Maximum number of children files for further analysis
+        self.max_children = self.config.getint(
+            "archive-extractor", "max_children", fallback=1000
+        )
+
+    def debloat_pe(self, child_contents: bytes) -> Optional[bytes]:
+        if HAS_DEBLOAT is False:
+            self.log.info(
+                "Child looks like bloated PE file, but debloat is not installed."
+            )
+            return None
+
+        try:
+            pe = pefile.PE(data=child_contents)
+        except Exception:
+            self.log.warning("Failed to load as PE file.")
+            return None
+
+        with tempfile.NamedTemporaryFile() as f:
+            process_pe(
+                pe, out_path=f.name, unsafe_processing=False, log_message=self.log.info
+            )
+            processed = f.read()
+
+        if processed:
+            return processed
+        else:
+            self.log.warning("Output file is empty - failed to debloat file")
+            return None
+
     def process(self, task: Task) -> None:
         sample = task.get_resource("sample")
         task_password = task.get_payload("password", default=None)
 
         attributes = task.get_payload("attributes", default={})
         if not task_password and attributes.get("password"):
             self.log.info("Accepting password from attributes")
@@ -102,15 +152,26 @@
             if not child.contents:
                 self.log.warning(
                     "Child has no contents or protected by unknown password"
                 )
                 continue
 
             if len(child.contents) > self.max_size:
-                self.log.warning("Child is too big for further processing")
+                if child.contents[:2] == b"MZ":
+                    debloated = self.debloat_pe(child.contents)
+                    if debloated is not None:
+                        child.contents = debloated
+
+            # Is it still too big?
+            if len(child.contents) > self.max_size:
+                self.log.warning(
+                    "Child is too big for further processing (%d > %d)",
+                    len(child.contents),
+                    self.max_size,
+                )
                 continue
 
             task = Task(
                 headers={
                     "type": "sample",
                     "kind": "raw",
                     "quality": task.headers.get("quality", "high"),
```

## Comparing `karton_archive_extractor-1.3.1-nspkg.pth` & `karton_archive_extractor-1.4.0-nspkg.pth`

 * *Files identical despite different names*

## Comparing `karton_archive_extractor-1.3.1.dist-info/LICENSE` & `karton_archive_extractor-1.4.0.dist-info/LICENSE`

 * *Files identical despite different names*

## Comparing `karton_archive_extractor-1.3.1.dist-info/METADATA` & `karton_archive_extractor-1.4.0.dist-info/METADATA`

 * *Files 23% similar despite different names*

```diff
@@ -1,39 +1,44 @@
 Metadata-Version: 2.1
 Name: karton-archive-extractor
-Version: 1.3.1
+Version: 1.4.0
 Summary: Extractor of various archive formats for Karton framework
 Home-page: https://github.com/CERT-Polska/karton-archive-extractor/
 License: UNKNOWN
 Platform: UNKNOWN
 Classifier: Programming Language :: Python
 Classifier: Operating System :: OS Independent
 Description-Content-Type: text/markdown
+License-File: LICENSE
 Requires-Dist: SFlock2 (==0.3.36)
 Requires-Dist: karton-core (<6.0.0,>=5.0.0)
+Provides-Extra: debloat
+Requires-Dist: debloat (==1.3.2.1) ; extra == 'debloat'
+Requires-Dist: pefile ; extra == 'debloat'
 
 # Extractor karton service
 
 Performs extraction of known archive types and e-mail attachments. Produces "raw" artifacts for further classification.
 
 **Author**: CERT.pl
 
-**Maintainers**: psrok1, nazywam, msm
+**Maintainers**: psrok1, nazywam
 
 **Consumes:**
 ```
 {
     "type":  "sample",
     "stage": "recognized",
     "kind":  "archive"
     "payload": {
         "sample": <Resource>,
         "extraction_level": <int, default: 0>,
+        "password": <archive password>,
     }
-} 
+}
 ```
 
 **Produces:**
 ```
 {
     "type": "sample",
     "kind": "raw",
@@ -65,14 +70,30 @@
 
 ```shell
 $ pip install karton-archive-extractor
 
 $ karton-archive-extractor
 ```
 
+### Configuration
+
+There are several configuration options you can tweak up to your liking.
+
+```ini
+[archive-extractor]
+# Maximum levels of nested extraction
+max_depth = 5
+# Maximum unpacked child filesize, larger files are not reported
+max_size = 26214400
+# Maximum number of children files for further analysis
+max_children = 1000
+```
+
+To learn more about configuring your karton services, take a look at [karton configuration docs](https://karton-core.readthedocs.io/en/latest/service_configuration.html)
+
 ## Running in Docker
 
 Sflock uses [ZipJail](https://github.com/hatching/tracy/tree/master/src/zipjail) as a usermode syscall filtering mechanism. As a result, in our experience, container running the karton service has to have the `SYS_PTRACE` capability in order for the ptrace to execute correctly. Make sure it's enabled if you run into problems extracting certain archive types.
 
 ## Supported archive/compression formats*
 
 ```
@@ -100,13 +121,24 @@
 .vhdx
 .xz
 .zip
 ```
 
 \* Assuming you are running Linux, please see the [sflock's readme](https://github.com/doomedraven/sflock/blob/master/README.md) for more information
 
+## PE files debloating
+
+Some malicious PE files contain intentionally added junk to make them too big for processing. Starting from v1.4.0, archive extractor 
+supports optional debloating of these files, using [debloat tool made by Squiblydoo](https://github.com/Squiblydoo/debloat). 
+
+`certpl/karton-archive-extractor` Docker image debloats PE files by default. To enable debloating in 
+karton-archive-extractor installed from PyPI, you need to install additional extra dependencies:
+
+```
+pip install karton-archive-extractor[debloat]
+```
 
 ---
 
 ![Co-financed by the Connecting Europe Facility by of the European Union](https://www.cert.pl/uploads/2019/02/en_horizontal_cef_logo-e1550495232540.png)
```

